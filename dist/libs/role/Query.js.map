{"version":3,"sources":["../../../src/libs/role/Query.js"],"names":["Query","constructor","role","mode","targetRole","_mode","_resources","_resource","undefined","_params","clear","resource","param","Array","isArray","forEach","res","push","canAny","action","can","canOwn","actions","type","resKey","Error","targetRes","length","all","grantActionToPerms","params","cannot","map","i","cannotAny","cannotOwn","typeAvailable","obj","newobj","convertToAnyOwn","forcePushArray","ntype","parseNeg","item","negcnt","c","substr","arr","pitem","isNeg","proidx","indexOf","splice","negidx","permarr","any","own","module","exports"],"mappings":"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","file":"Query.js","sourcesContent":["class Query {\n    constructor({ role, mode }) {\n        this.targetRole = role\n        this._mode = mode\n        this._resources = []\n        this._resource = undefined\n        this._params = []\n    }\n\n    clear() {\n        this._resources = []\n        this._resource = undefined\n        this._params = []\n    }\n\n    resource(resource, param) {\n        this.clear()\n        this._resource = resource\n        if (Array.isArray(resource)) {\n            resource.forEach(res => {\n                this._resources.push(res)\n            })\n        } else {\n            this._resources.push(resource)\n        }\n\n        if (param) {\n            return this.param(param)\n        }\n\n        return this\n    }\n\n    param(param) {\n        if (Array.isArray(param)) {\n            this._params.push(...param)\n        } else {\n            this._params.push(param)\n        }\n        return this\n    }\n\n    canAny(action) {\n        return this.can(action, 'any')\n    }\n\n    canOwn(action) {\n        return this.can(action, 'own')\n    }\n\n    can(actions, type) {\n        if (!Array.isArray(actions)) {\n            actions = [actions]\n        }\n\n        const resKey = this._resource\n        if (!resKey) {\n            throw new Error('Need a resource to be granted.')\n        }\n\n        const targetRes = this.targetRole.resource(resKey)\n\n        actions.forEach(action => {\n            if (this._params.length === 0) {\n                if (!targetRes.all) {\n                    targetRes.all = []\n                }\n                targetRes.all = grantActionToPerms(targetRes.all, action, type)\n            } else {\n                if (!targetRes.params) {\n                    targetRes.params = {}\n                }\n                this._params.forEach(param => {\n                    if (!targetRes.params[param]) {\n                        targetRes.params[param] = []\n                    }\n\n                    targetRes.params[param] = grantActionToPerms(\n                        targetRes.params[param],\n                        action,\n                        type\n                    )\n                })\n            }\n        })\n\n        return this\n    }\n\n    cannot(action, type) {\n        if (!Array.isArray(action)) {\n            action = [action]\n        }\n        return this.can(\n            action.map(i => `!${i}`),\n            type\n        )\n    }\n\n    cannotAny(action) {\n        return this.cannot(action, 'any')\n    }\n\n    cannotOwn(action) {\n        return this.cannot(action, 'own')\n    }\n}\n\nconst typeAvailable = ['any', 'own']\n\nfunction grantActionToPerms(obj, action, type) {\n    if (Array.isArray(obj)) {\n        if (type) {\n            let newobj = convertToAnyOwn(obj)\n            newobj[type] = forcePushArray(newobj[type], action)\n            return newobj\n        } else {\n            // obj.push(action)\n            obj = forcePushArray(obj, action)\n            return obj\n        }\n    } else {\n        if (type) {\n            obj[type] = forcePushArray(obj[type], action)\n            return obj\n        } else {\n            typeAvailable.forEach(ntype => {\n                obj[ntype] = forcePushArray(obj[ntype], action)\n            })\n            return obj\n        }\n    }\n}\n\n// function grantToAnyOwn(obj, action, type) {\n//     if (!Array.isArray(obj[type])) {\n//         obj[type] = forcePushArray(obj[type], action)\n//     }\n// }\n\nfunction parseNeg(item) {\n    let negcnt = 0\n    let c\n    for (c of item) {\n        if (c !== '!') {\n            break\n        }\n        negcnt++\n    }\n    return [negcnt, item.substr(negcnt)]\n}\n\nfunction forcePushArray(arr, item) {\n    if (!Array.isArray(arr)) {\n        return [item]\n    }\n\n    const [negcnt, pitem] = parseNeg(item)\n    const isNeg = negcnt % 2 === 1\n\n    if (isNeg) {\n        const proidx = arr.indexOf(pitem)\n        if (proidx >= 0) {\n            arr.splice(proidx, 1)\n        }\n\n        if (arr.indexOf(`!${pitem}`) < 0) {\n            arr.push(`!${pitem}`)\n        }\n    } else {\n        const negidx = arr.indexOf(`!${item}`)\n        if (negidx >= 0) {\n            arr.splice(negidx, 1)\n        }\n\n        if (arr.indexOf(item) < 0) {\n            arr.push(item)\n        }\n    }\n\n    return arr\n}\n\nfunction convertToAnyOwn(permarr) {\n    return { any: [...permarr], own: [...permarr] }\n}\n\nmodule.exports = Query\n"]}