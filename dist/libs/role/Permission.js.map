{"version":3,"sources":["../../../src/libs/role/Permission.js"],"names":["checkAction","arr","action","indexOf","undefined","hasPermission","permobj","type","Array","isArray","Error","Permission","constructor","resources","param","res","can","range","results","map","resource","result","all","params","canOwn","module","exports"],"mappings":";;AAAA,SAASA,WAAT,CAAqBC,GAArB,EAA0BC,MAA1B,EAAkC;AAC9B,QAAID,IAAIE,OAAJ,CAAYD,MAAZ,KAAuB,CAA3B,EAA8B;AAC1B,eAAO,IAAP;AACH;AACD,QAAID,IAAIE,OAAJ,CAAY,MAAMD,MAAlB,KAA6B,CAAjC,EAAoC;AAChC,eAAO,KAAP;AACH;AACD,WAAOE,SAAP;AACH;;AAED,SAASC,aAAT,CAAuBC,OAAvB,EAAgCC,IAAhC,EAAsCL,MAAtC,EAA8C;AAC1C,QAAIM,MAAMC,OAAN,CAAcH,OAAd,CAAJ,EAA4B;AACxB,eAAON,YAAYM,OAAZ,EAAqBJ,MAArB,CAAP;AACH,KAFD,MAEO;AACH,YAAII,QAAQC,IAAR,CAAJ,EAAmB;AACf,gBAAIC,MAAMC,OAAN,CAAcH,QAAQC,IAAR,CAAd,CAAJ,EAAkC;AAC9B,uBAAOP,YAAYM,QAAQC,IAAR,CAAZ,EAA2BL,MAA3B,CAAP;AACH,aAFD,MAEO;AACH,sBAAM,IAAIQ,KAAJ,CAAW,IAAGH,IAAK,6BAAnB,CAAN;AACH;AACJ,SAND,MAMO;AACH,kBAAM,IAAIG,KAAJ,CAAW,IAAGH,IAAK,uBAAnB,CAAN;AACH;AACJ;AACJ;;AAED,MAAMI,UAAN,CAAiB;AACbC,gBAAYC,SAAZ,EAAuBC,KAAvB,EAA8B;AAC1B,YAAI,CAACN,MAAMC,OAAN,CAAcI,SAAd,CAAL,EAA+B;AAC3BA,wBAAY,CAACA,SAAD,CAAZ;AACH;AACD,aAAKE,GAAL,GAAWF,SAAX;AACA,aAAKC,KAAL,GAAaA,KAAb;AACH;;AAEDE,QAAId,MAAJ,EAAYe,KAAZ,EAAmB;AACfA,gBAAQA,SAAS,KAAjB;;AAEA,YAAIC,UAAU,KAAKH,GAAL,CAASI,GAAT,CAAaC,YAAY;AACnC,gBAAIC,SAAS,KAAb;;AAEA,gBAAI,CAACD,QAAL,EAAe;AACX,uBAAO,KAAP;AACH;;AAED,gBAAIA,SAASE,GAAb,EAAkB;AACdD,yBAAShB,cAAce,SAASE,GAAvB,EAA4BL,KAA5B,EAAmCf,MAAnC,CAAT;AACH;;AAED,gBAAI,KAAKY,KAAT,EAAgB;AACZ,oBAAIM,SAASG,MAAT,IAAmBH,SAASG,MAAT,CAAgB,KAAKT,KAArB,CAAvB,EAAoD;AAChD,4BACIT,cACIe,SAASG,MAAT,CAAgB,KAAKT,KAArB,CADJ,EAEIG,KAFJ,EAGIf,MAHJ,CADJ;AAOI,6BAAK,IAAL;AACI,mCAAO,IAAP;AACJ,6BAAK,KAAL;AACI,mCAAO,KAAP;AAVR;AAYH;AACJ;AACD,mBAAO,CAAC,CAACmB,MAAT;AACH,SA5Ba,CAAd;;AA8BA,eAAOH,QAAQf,OAAR,CAAgB,IAAhB,KAAyB,CAAhC;AACH;;AAEDqB,WAAOtB,MAAP,EAAe;AACX,eAAO,KAAKc,GAAL,CAASd,MAAT,EAAiB,KAAjB,CAAP;AACH;AA/CY;;AAkDjBuB,OAAOC,OAAP,GAAiBf,UAAjB","file":"Permission.js","sourcesContent":["function checkAction(arr, action) {\n    if (arr.indexOf(action) >= 0) {\n        return true\n    }\n    if (arr.indexOf('!' + action) >= 0) {\n        return false\n    }\n    return undefined\n}\n\nfunction hasPermission(permobj, type, action) {\n    if (Array.isArray(permobj)) {\n        return checkAction(permobj, action)\n    } else {\n        if (permobj[type]) {\n            if (Array.isArray(permobj[type])) {\n                return checkAction(permobj[type], action)\n            } else {\n                throw new Error(`'${type}' field should be an array.`)\n            }\n        } else {\n            throw new Error(`'${type}' field should exist.`)\n        }\n    }\n}\n\nclass Permission {\n    constructor(resources, param) {\n        if (!Array.isArray(resources)) {\n            resources = [resources]\n        }\n        this.res = resources\n        this.param = param\n    }\n\n    can(action, range) {\n        range = range || 'any'\n\n        let results = this.res.map(resource => {\n            let result = false\n\n            if (!resource) {\n                return false\n            }\n\n            if (resource.all) {\n                result = hasPermission(resource.all, range, action)\n            }\n\n            if (this.param) {\n                if (resource.params && resource.params[this.param]) {\n                    switch (\n                        hasPermission(\n                            resource.params[this.param],\n                            range,\n                            action\n                        )\n                    ) {\n                        case true:\n                            return true\n                        case false:\n                            return false\n                    }\n                }\n            }\n            return !!result\n        })\n\n        return results.indexOf(true) >= 0\n    }\n\n    canOwn(action) {\n        return this.can(action, 'own')\n    }\n}\n\nmodule.exports = Permission\n"]}